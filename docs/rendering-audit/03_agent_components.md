# Agent Components - Response & UI Block Renderers

**Date**: 2025-09-25
**Branch**: fix-dockerfile
**Commit**: 3cb52b172c1d9e0e33995ecfe1e5ec05e2f019f6
**Author**: Claude Code (automated audit)

## Overview

The application uses UI blocks to render rich content components including charts, tables, KPIs, and alerts. These blocks are generated by the backend and rendered by frontend components.

## UI Block Types

### Backend Block Types (GPT-5 Agent)

| Block Type | Purpose | Data Structure | Frontend Component |
|------------|---------|----------------|-------------------|
| `kpi_card` | Key metrics display | value, formatted_value, change, icon | Motion-animated card |
| `table` | Data tables | headers, rows, formatting | Enhanced table with highlighting |
| `line_chart` | Time series | labels, datasets, average_line | ResponsiveContainer + LineChart |
| `bar_chart` | Comparisons | labels, datasets | ResponsiveContainer + BarChart |
| `pie_chart` | Distributions | labels, values, colors, percentages | ResponsiveContainer + PieChart |
| `equation` | Math formulas | latex, variables, result, steps | BlockMath + calculation display |
| `alert` | Notifications | severity, message, details, action | Alert with severity styling |
| `text` | Rich text | content (markdown) | ReactMarkdown in Card |

## Component: PennyResponseRenderer

**Location**: `components/chat/penny-response-renderer.tsx`

### Main Render Function
**Lines 57-691**:
- Entry point for all dashboard responses
- Processes both markdown content and UI blocks
- Applies scrub function to content (lines 53-55)

### Scrub Function
**Lines 53-55**:
```tsx
const scrub = (s: string) =>
  s.replace(/[\u200B-\u200D\uFEFF\u2060]/g, '') // zero-widths
   .replace(/\u2009|\u202f/g, ' ')               // thin/narrow spaces
```

### Main Content Rendering
**Lines 516-533**:
```tsx
<div className="prose prose-base dark:prose-invert max-w-none tabular-nums leading-relaxed break-words">
  <ReactMarkdown
    remarkPlugins={[remarkGfm, remarkBreaks, remarkMath]}
    rehypePlugins={[rehypeKatex]}
    components={{...}}
  >
    {safeContent}
  </ReactMarkdown>
</div>
```

### UI Block Rendering
**Lines 470-510**:
```tsx
const renderUIBlock = (block: any) => {
  switch (block.type) {
    case 'kpi_card': return renderKPICard(block)
    case 'table': return renderTable(block)
    case 'line_chart': return renderLineChart(block)
    case 'bar_chart': return renderBarChart(block)
    case 'pie_chart': return renderPieChart(block)
    case 'equation': return renderEquation(block)
    case 'alert': return renderAlert(block)
    case 'text': return (...)
    default: return null
  }
}
```

## Individual Block Renderers

### KPI Card Renderer
**Lines 63-94**:
- Motion animations on mount
- Icon selection based on type
- Formatted values with change indicators
- Color coding for positive/negative changes

### Table Renderer
**Lines 96-173**:
- Auto-detection of numeric columns (lines 101-112)
- Tabular-nums class for numeric alignment
- Conditional formatting support
- Total row rendering

### Chart Renderers

**Line Chart (175-252)**:
- Recharts ResponsiveContainer wrapper
- Support for average line overlay
- Currency formatting in tooltips
- Error handling for malformed data

**Bar Chart (254-311)**:
- Similar structure to line chart
- Rounded bar corners
- Legend and tooltip support

**Pie Chart (313-374)**:
- Dynamic color assignment from CHART_COLORS
- Percentage label support
- Configurable legend display

### Equation Renderer
**Lines 376-429**:
- LaTeX math rendering with BlockMath
- Variable display section
- Step-by-step breakdown
- Highlighted result display

### Alert Renderer
**Lines 431-468**:
- Severity-based styling (warning, info, success, error)
- Icon matching severity
- Optional action buttons as Badges
- Motion animation from left

## Metadata Sections

### Computations Section
**Lines 547-606**:
- Renders calculation details
- Special handling for:
  - Portfolio projections
  - Savings capacity analysis
  - Generic numeric results
- Formula display with results

### Assumptions Section
**Lines 609-622**:
- List format for assumptions
- Muted text styling
- Automatic enumeration

### Investment Projection Summary
**Lines 625-688**:
- Grid layout for key metrics
- Yearly projections table
- Sliced to first 10 years
- Currency formatting throughout

## Backend UI Block Generation

### Location: `TRUEFIBACKEND/agents/gpt5_unified_agent.py`

**UI Block Normalization** (line 622):
```python
result['ui_blocks'] = self._normalize_ui_blocks(result['ui_blocks'])
```

**Financial Snapshot Generation** (lines 768-820):
```python
ui_blocks = [
    {
        "type": "kpi_card",
        "title": "Monthly Income",
        "data": {
            "value": income,
            "formatted_value": f"${income:,.0f}",
            "subtitle": "After tax",
            "icon": "wallet"
        }
    },
    # ... more KPI cards
]
```

## Data Flow for UI Blocks

```
GPT-5 Response
    ↓
gpt5_unified_agent.py
    ├─ Parse JSON response
    ├─ Extract ui_blocks array
    └─ Normalize block structure
    ↓
orchestrator_gpt5.py
    ├─ Pass through result
    └─ Add to rich_content
    ↓
main.py /chat endpoint
    ├─ Include in response.rich_content
    └─ Send to frontend
    ↓
Frontend Route Handler
    ├─ Extract from data.rich_content
    └─ Pass as metadata prop
    ↓
PennyResponseRenderer
    ├─ Render markdown content
    ├─ Map ui_blocks to components
    └─ Display metadata sections
```

## Component Dependencies

### NPM Packages:
```json
"recharts": "^2.12.7",
"react-katex": "^3.0.1",
"katex": "^0.16.11",
"framer-motion": "^11.11.17",
"lucide-react": "^0.460.0"
```

### UI Components:
- `@/components/ui/card`
- `@/components/ui/table`
- `@/components/ui/badge`
- `@/components/ui/alert`

## Rendering Features

### Animation:
- All blocks use framer-motion
- Staggered animations for lists
- Scale and fade effects

### Responsive Design:
- ResponsiveContainer for charts
- Overflow scrolling for tables
- Grid layouts for KPIs

### Accessibility:
- Semantic HTML structure
- ARIA labels via component library
- Color contrast for severity indicators

## Known Issues

1. **Type Safety**: All blocks typed as `any`
2. **Error Boundaries**: No error boundaries around block renderers
3. **Data Validation**: Limited validation of block data structure
4. **Performance**: No memoization of expensive renders
5. **Chart Colors**: Fixed palette may not handle >8 series

## Block Type Usage Statistics

From backend analysis:
- **Most Common**: `kpi_card` (financial metrics)
- **Data Heavy**: `table` (transaction lists)
- **Visualizations**: `line_chart` (trends), `pie_chart` (spending)
- **Rare**: `equation` (complex calculations)

## Security Considerations

1. **Markdown Injection**: Using ReactMarkdown with limited components
2. **LaTeX Injection**: KaTeX in strict mode
3. **Data Sanitization**: Scrub function for zero-width chars
4. **XSS Prevention**: React's built-in escaping

## Performance Optimizations

### Current:
- Lazy rendering of UI blocks
- ResponsiveContainer for chart sizing
- Motion animations with GPU acceleration

### Missing:
- React.memo for block components
- Virtual scrolling for large tables
- Code splitting for chart libraries
- Skeleton loaders during data fetch
substitutions:
  _AR_REGION: us-west2
  _AR_REPO: truefi-images
  _IMAGE_NAME: penny-api
  _RUN_REGION: us-central1
  _SERVICE: truefi-api-service
  _CLOUDSQL: truefi:us-central1:true-fi-db

steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-t', '${_AR_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_IMAGE_NAME}:$SHORT_SHA',
      '-f', 'true-fi-back-end/Dockerfile',
      './true-fi-back-end'
    ]

  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'push',
      '${_AR_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_IMAGE_NAME}:$SHORT_SHA'
    ]

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: [
      'run', 'deploy', '${_SERVICE}',
      '--image', '${_AR_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_IMAGE_NAME}:$SHORT_SHA',
      '--region', '${_RUN_REGION}',
      '--platform', 'managed',
      '--service-account', '118529284371-compute@developer.gserviceaccount.com',
      '--add-cloudsql-instances', '${_CLOUDSQL}',
      '--allow-unauthenticated',
      '--port', '8000',
      '--memory', '512Mi',
      '--cpu', '1',
      '--max-instances', '10',
      '--set-env-vars', 'DB_HOST=/cloudsql/${_CLOUDSQL},DB_PORT=5432,DB_NAME=truefi_db,DB_USER=truefi_user,DB_SSL_MODE=disable',
      '--set-secrets', 'DB_PASSWORD=DB_PASSWORD:latest'
    ]

images:
  - '${_AR_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_IMAGE_NAME}:$SHORT_SHA'